{% extends "base.html" %}

{% block title %}Messages{% endblock %}

{% block content %}
<div class="container">
  <h2>Voice Messages <img src="../static/chat-left-text.svg" alt="" width="32" height="32">
  {% if total_unplayed > 0 %}
    <i><span class="badge badge-primary"><span id="total-unplayed">{{ total_unplayed }}</span> New </span></i>
  {% endif %}
  </h2>

  {% if total_messages == 0 %}
  <h4><i>None</i></h4>
  {% else %}
  {{ pagination.links }}
  <table class="table">
    <thead>
      <tr>
        <th>Message</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for item in messages %}
      <tr>
        <td>
          <a href="#"><b>{{ item.time }}</b></a>
          {{ item.date }}
          {% if item.msg_played == 0 %}
          <span id="msg-{{ item.msg_no }}" class="badge badge-pill badge-primary"><i> New </i></span>
          {% endif %}
          <span class="d-lg-none"><br></span>
          <a href="/caller/manage/{{ item.call_no }}"><b>{{ item.phone_no }}</b></a>
          <i>{{ item.name }}</i>
          <span class="d-lg-none"><br></span>
          <audio id="audio" controls preload="metadata" data-msg-no="{{ item.msg_no }}" data-msg-played="{{ item.msg_played }}">
            <source src="{{ item.wav_file }}" type="audio/wav">
            Your browser does not support the audio element.
          </audio>
        </td>
        <td class="px-1">
          <button type="button" class="btn btn-outline-light text-dark" onClick="location.href='/messages/delete/{{ item.msg_no }}'">
            <img src="../static/trash.svg" alt="" width="32" height="32" title="Delete Message">
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {{ pagination.links }}
  {% endif %}
</div>
{% endblock %}

{% block js %}
<script>
$("audio").on('play', function(e) {
  var $audio = $(e.currentTarget)
  var message_no = $audio.data('msg-no')
  var msg_played = $audio.data('msg-played')
  if (msg_played == 0) {
    // Set the status to 1; "played"
    var data = { msg_no: message_no, status: 1 }
    $.post("/messages/played", data, function(results) {
        if (results.success) {
          $('#msg-'+results.msg_no).remove()
          $('#total-unplayed').text(results.unplayed_count)
        }
    });
  }
});

// Make table(s) responsive when small
function handleMediaQuery(x) {
  if (x.matches) { // If media query matches
      $('table').addClass('table-responsive')
  } else {
      $('table').removeClass('table-responsive')
  }
}
var x = window.matchMedia("(max-width: 500px)")
handleMediaQuery(x)             // Call listener function at run time
x.addListener(handleMediaQuery) // Attach listener function on state changes
</script>
{% endblock %}
